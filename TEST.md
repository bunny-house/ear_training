# 测试说明

## 安装测试依赖

```bash
npm install
```

## 运行测试

```bash
# 运行所有测试
npm test

# 运行测试并监听文件变化
npm test -- --watch

# 运行测试并生成覆盖率报告
npm run test:coverage

# 运行测试UI（可视化界面）
npm run test:ui
```

## 测试文件说明

### 测试文件位置约定

**推荐位置**：`src/components/__tests__/` 目录

使用 `__tests__` 目录的优势：
- ✅ 保持源代码目录更干净，测试文件不混在源代码中
- ✅ 测试文件集中管理，便于维护
- ✅ 符合 Vitest/Jest 等测试框架的常见约定
- ✅ 便于在构建时排除测试文件

**当前状态**：
- `NoteGrid.spec.js` 已移动到 `src/components/__tests__/` ✅
- 其他测试文件（如 `GameHeader.spec.js` 等）建议也移动到 `__tests__` 目录

### NoteGrid.spec.js

位置：`src/components/__tests__/NoteGrid.spec.js`

这个测试文件针对 **NoteGrid 组件**进行全面测试，包括序列模式和单音模式。

#### 测试覆盖的场景：

1. **重复音符点击测试（序列模式）**
   - ✅ 允许用户重复点击相同的音符
   - ✅ 正确显示重复音符的序号标志（如 "1,2"）
   - ✅ 能够完成包含重复音符的序列

2. **反馈显示测试（序列模式）**
   - ✅ 正确标记重复音符的正确位置
   - ✅ 正确标记重复音符的错误位置
   - ✅ 正确处理部分正确的重复音符序列
   - ✅ 正确标记未点击的重复音符（dimmed状态）

3. **单音模式测试**
   - ✅ 点击音符时触发 select 事件
   - ✅ 正确显示正确/错误反馈
   - ✅ 正确显示未选择的音符（dimmed）
   - ✅ 不显示序号标志

4. **禁用状态测试**
   - ✅ disabled 属性正确应用
   - ✅ 禁用状态下阻止点击

5. **序号标志显示测试**
   - ✅ 为序列中的每个音符显示正确的序号
   - ✅ 为重复音符显示多个序号

6. **反馈状态测试**
   - ✅ 正确标记完全正确/错误的序列
   - ✅ 无反馈时不显示任何状态

7. **属性验证**
   - ✅ chromatic 模式样式
   - ✅ showNoteVal 属性控制音符值显示

8. **序列重置测试**
   - ✅ disabled 状态变化时重置序列

9. **边界情况测试**
   - ✅ 处理所有音符都相同的情况
   - ✅ 序列长度达到后阻止继续点击

### GameTimer.spec.js

测试 **GameTimer 组件**的计时功能。

#### 测试覆盖的场景：

1. **时间格式化**
   - ✅ 正确格式化 00:00
   - ✅ 正确格式化分钟和秒数
   - ✅ 正确处理超过1小时的情况

2. **计时器启动和停止**
   - ✅ running 为 true 时开始计时
   - ✅ running 为 false 时停止计时
   - ✅ 每100ms更新一次时间

3. **计时器重置**
   - ✅ reset 为 true 时重置计时器
   - ✅ 重置时停止计时器

4. **getElapsedTime 方法**
   - ✅ 通过 defineExpose 暴露方法
   - ✅ 返回当前的 elapsedTime

5. **组件卸载**
   - ✅ 卸载时清理定时器

6. **边界情况**
   - ✅ 快速切换 running 状态
   - ✅ 从停止状态直接重置

### GameHeader.spec.js

测试 **GameHeader 组件**的显示和交互。

#### 测试覆盖的场景：

1. **显示内容**
   - ✅ 正确显示关卡、轮次、得分信息
   - ✅ 包含返回按钮和 GameTimer 组件

2. **事件处理**
   - ✅ 点击返回按钮触发 back 事件
   - ✅ 传递 timerRunning 属性给 GameTimer

3. **计时器集成**
   - ✅ 处理计时器的 update:elapsed 事件
   - ✅ 通过 getElapsedTime 暴露经过的时间

4. **边界情况**
   - ✅ 正确处理最后一轮/第一轮
   - ✅ 正确处理零分/高分
   - ✅ 正确处理所有关卡（0-6）

### GameResult.spec.js

测试 **GameResult 组件**的游戏结果展示。

#### 测试覆盖的场景：

1. **显示内容**
   - ✅ 显示游戏结束标题
   - ✅ 正确显示最终得分
   - ✅ 正确格式化并显示总用时
   - ✅ 显示再玩一次和返回菜单按钮

2. **时间格式化**
   - ✅ 正确格式化 0 秒、不到1分钟、1分钟、超过1小时
   - ✅ 正确处理带小数的秒数（向下取整）

3. **事件处理**
   - ✅ 点击再玩一次按钮触发 restart 事件
   - ✅ 点击返回菜单按钮触发 back 事件

4. **边界情况**
   - ✅ 正确处理满分/零分/超过满分
   - ✅ 正确处理所有关卡
   - ✅ 正确处理非常长的时间

### ReferenceToggle.spec.js

测试 **ReferenceToggle 组件**的双向绑定和交互。

#### 测试覆盖的场景：

1. **显示内容**
   - ✅ 显示标签文本和复选框

2. **双向绑定**
   - ✅ 正确反映 modelValue 的值
   - ✅ 复选框改变时发出 update:modelValue 事件

3. **用户交互**
   - ✅ 可以通过点击标签来切换
   - ✅ 可以通过直接点击复选框来切换

4. **边界情况**
   - ✅ 正确处理默认值
   - ✅ 正确处理多次快速切换
   - ✅ 正确处理外部 prop 更新

5. **可访问性**
   - ✅ 正确关联标签和输入

### levels.spec.js

测试 **levels.js 工具函数**的配置和逻辑。

#### 测试覆盖的场景：

1. **LEVELS 配置**
   - ✅ 包含所有7个关卡
   - ✅ 每个关卡有必需的属性
   - ✅ 各关卡的模式和配置正确

2. **notesConfig**
   - ✅ 包含所有音符
   - ✅ 每个音符有必需的属性
   - ✅ 包含 High Do

3. **getLevelConfig**
   - ✅ 返回正确的关卡配置
   - ✅ 返回 undefined 对于不存在的关卡

4. **getNotesForLevel**
   - ✅ Level 0 返回空数组
   - ✅ Level 1/2/3 返回白键（不含低音Do，含High Do）
   - ✅ Level 4/5/6 返回半音阶（不含低音Do，含High Do）

5. **getWhiteKeyNotes**
   - ✅ 返回所有白键（不含High Do）
   - ✅ 包含低音Do

6. **calculateScore**
   - ✅ 单音模式：正确答案得10分，错误答案得0分
   - ✅ Level 2 (partial)：两个都对10分，对一个5分，都错0分
   - ✅ Level 3 (proportional)：按比例计分，保留两位小数
   - ✅ 边界情况：无效关卡、缺少参数、长度不匹配、重复音符

## Bug 描述

**原始问题**：
在序列模式（Level 2/3）中，如果目标序列包含重复的音符（例如：Re, Re, Mi），用户只能点击一次 Re，因为代码中有 `if (userSequence.value.includes(noteVal)) return;` 的检查，导致无法完成序列。

**修复方案**：
1. 移除了阻止重复点击的检查
2. 改为检查序列长度是否达到目标长度
3. 改进了序号标志显示，支持显示多个位置（如 "1,2"）
4. 改进了反馈显示逻辑，正确处理重复音符的正确/错误状态

## 运行示例

```bash
# 运行 NoteGrid 组件的测试
npm test NoteGrid

# 运行特定测试用例
npm test -- -t "应该允许用户重复点击相同的音符"
```
